name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ptd-fitness-demo
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY_REPO: geminivideo-repo
  GCS_BUCKET: ptd-fitness-demo_cloudbuild

jobs:
  deploy:
    name: Build and Deploy Services
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GCP Authentication
        run: |
          # Check if secret exists
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "âŒ ERROR: GCP_SA_KEY secret is not configured"
            echo "Please add it at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 1
          fi

          echo "Decoding GCP service account key..."
          echo "${{ secrets.GCP_SA_KEY }}" | base64 -d > /tmp/gcp-key.json

          echo "Activating service account..."
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json

          echo "Setting GCP project..."
          gcloud config set project ${{ env.PROJECT_ID }}

          echo "âœ… GCP Authentication successful"

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      # CRITICAL FIX: Sync configs to GCS FIRST (before building containers)
      - name: Sync Configs to GCS
        run: |
          echo "ðŸ“¦ Syncing shared config to GCS..."
          if [ -d "shared/config" ]; then
            gsutil -m rsync -r -d ./shared/config gs://${{ env.GCS_BUCKET }}/config/
            echo "âœ… Config synced to gs://${{ env.GCS_BUCKET }}/config/"
          fi
          if [ -d "knowledge" ]; then
            gsutil -m rsync -r -d ./knowledge gs://${{ env.GCS_BUCKET }}/knowledge/
            echo "âœ… Knowledge synced to gs://${{ env.GCS_BUCKET }}/knowledge/"
          fi

      # CRITICAL FIX: Build and Deploy ML Service (MISSING FROM ORIGINAL!)
      - name: Build ML Service
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/ml-service:latest \
            ./services/ml-service
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/ml-service:latest

      - name: Deploy ML Service
        run: |
          gcloud run deploy ml-service \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/ml-service:latest \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=2Gi \
            --cpu=2 \
            --timeout=300 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }},GCS_BUCKET=${{ env.GCS_BUCKET }}"

      # Build and Deploy Drive Intel
      - name: Build Drive Intel
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/drive-intel:latest \
            ./services/drive-intel
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/drive-intel:latest

      - name: Deploy Drive Intel
        run: |
          gcloud run deploy drive-intel \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/drive-intel:latest \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --ingress=internal \
            --allow-unauthenticated \
            --memory=4Gi \
            --cpu=2 \
            --timeout=3600 \
            --max-instances=5 \
            --min-instances=0 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }},GCS_BUCKET=${{ env.GCS_BUCKET }}"

      # Build and Deploy Video Agent
      - name: Build Video Agent
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/video-agent:latest \
            ./services/video-agent
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/video-agent:latest

      - name: Deploy Video Agent
        run: |
          gcloud run deploy video-agent \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/video-agent:latest \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --ingress=internal \
            --allow-unauthenticated \
            --memory=4Gi \
            --cpu=2 \
            --timeout=600 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }},GCS_BUCKET=${{ env.GCS_BUCKET }}"

      # Build and Deploy Meta Publisher
      - name: Build Meta Publisher
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/meta-publisher:latest \
            ./services/meta-publisher
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/meta-publisher:latest

      - name: Deploy Meta Publisher
        run: |
          gcloud run deploy meta-publisher \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/meta-publisher:latest \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --ingress=internal \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }}"

      # Build and Deploy Gateway API
      - name: Build Gateway API
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/gateway-api:latest \
            ./services/gateway-api
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/gateway-api:latest

      - name: Deploy Gateway API
        run: |
          # CRITICAL FIX: Get service URLs and pass to gateway-api
          DRIVE_INTEL_URL=$(gcloud run services describe drive-intel --region=${{ env.GCP_REGION }} --format='value(status.url)' 2>/dev/null || echo "")
          VIDEO_AGENT_URL=$(gcloud run services describe video-agent --region=${{ env.GCP_REGION }} --format='value(status.url)' 2>/dev/null || echo "")
          META_PUBLISHER_URL=$(gcloud run services describe meta-publisher --region=${{ env.GCP_REGION }} --format='value(status.url)' 2>/dev/null || echo "")
          ML_SERVICE_URL=$(gcloud run services describe ml-service --region=${{ env.GCP_REGION }} --format='value(status.url)' 2>/dev/null || echo "")

          gcloud run deploy gateway-api \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/gateway-api:latest \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --ingress=all \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --min-instances=1 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }},GCS_BUCKET=${{ env.GCS_BUCKET }},DRIVE_INTEL_URL=${DRIVE_INTEL_URL},VIDEO_AGENT_URL=${VIDEO_AGENT_URL},META_PUBLISHER_URL=${META_PUBLISHER_URL},ML_SERVICE_URL=${ML_SERVICE_URL}"

      # Build and Deploy Frontend
      - name: Build Frontend
        run: |
          FRONTEND_DIR="services/frontend"
          if [ ! -d "$FRONTEND_DIR" ]; then
            FRONTEND_DIR="frontend"
          fi

          # Get Gateway URL for frontend
          GATEWAY_URL=$(gcloud run services describe gateway-api --region=${{ env.GCP_REGION }} --format='value(status.url)' 2>/dev/null || echo "")

          # Build with API URL
          docker build \
            --build-arg VITE_API_URL=${GATEWAY_URL} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/frontend:latest \
            ./${FRONTEND_DIR}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/frontend:latest

      - name: Deploy Frontend
        run: |
          GATEWAY_URL=$(gcloud run services describe gateway-api --region=${{ env.GCP_REGION }} --format='value(status.url)' 2>/dev/null || echo "")

          gcloud run deploy frontend \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/frontend:latest \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --ingress=all \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --set-env-vars="VITE_API_URL=${GATEWAY_URL}"

      - name: Show Deployment Status
        if: always()
        run: |
          echo "================================================"
          echo "ðŸš€ Deployment Status - $(date)"
          echo "================================================"
          echo ""
          gcloud run services list --region=${{ env.GCP_REGION }} --format="table(SERVICE:label='Service',URL:label='URL')"
          echo ""
          echo "================================================"
          echo "âœ… All services deployed successfully!"
          echo "================================================"
