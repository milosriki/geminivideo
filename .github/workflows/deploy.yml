name: Build, Test & Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  REGION: us-central1
  REGISTRY_NAME: geminivideo

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Lint Python services
        run: |
          pip install flake8
          # Lint drive-intel
          flake8 services/drive-intel --count --select=E9,F63,F7,F82 --show-source --statistics || true
          # Lint video-agent
          flake8 services/video-agent --count --select=E9,F63,F7,F82 --show-source --statistics || true

      - name: Lint TypeScript services
        run: |
          # Lint gateway-api
          cd services/gateway-api
          npm install
          npm run build || true
          cd ../..
          
          # Lint meta-publisher
          cd services/meta-publisher
          npm install
          npm run build || true
          cd ../..

      - name: Lint Frontend
        run: |
          cd frontend
          npm install
          npm run lint || true
          cd ..

      - name: Run Python tests
        run: |
          # Placeholder for Python tests
          echo "Python tests would run here"

  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and push drive-intel
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REGISTRY_NAME }}/drive-intel:${{ github.sha }}"
          docker build -t $IMAGE ./services/drive-intel
          docker push $IMAGE
          docker tag $IMAGE "${IMAGE%:*}:latest"
          docker push "${IMAGE%:*}:latest"

      - name: Build and push video-agent
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REGISTRY_NAME }}/video-agent:${{ github.sha }}"
          docker build -t $IMAGE ./services/video-agent
          docker push $IMAGE
          docker tag $IMAGE "${IMAGE%:*}:latest"
          docker push "${IMAGE%:*}:latest"

      - name: Build and push gateway-api
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REGISTRY_NAME }}/gateway-api:${{ github.sha }}"
          docker build -t $IMAGE ./services/gateway-api
          docker push $IMAGE
          docker tag $IMAGE "${IMAGE%:*}:latest"
          docker push "${IMAGE%:*}:latest"

      - name: Build and push meta-publisher
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REGISTRY_NAME }}/meta-publisher:${{ github.sha }}"
          docker build -t $IMAGE ./services/meta-publisher
          docker push $IMAGE
          docker tag $IMAGE "${IMAGE%:*}:latest"
          docker push "${IMAGE%:*}:latest"

      - name: Build and push frontend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REGISTRY_NAME }}/frontend:${{ github.sha }}"
          docker build -t $IMAGE ./frontend
          docker push $IMAGE
          docker tag $IMAGE "${IMAGE%:*}:latest"
          docker push "${IMAGE%:*}:latest"

  # Optional: Auto-deploy to staging/production
  # Uncomment and configure when ready
  # deploy:
  #   name: Deploy to Cloud Run
  #   runs-on: ubuntu-latest
  #   needs: build-and-push
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #     - name: Deploy services
  #       run: |
  #         # Deploy using gcloud run deploy commands
  #         echo "Deploy to Cloud Run"
