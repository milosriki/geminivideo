name: Supabase Deploy

on:
  push:
    branches: [main]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - '.github/workflows/supabase-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase CLI
        run: npm install -g supabase@latest

      - name: Verify Supabase config
        run: |
          if [ ! -f supabase/config.toml ]; then
            echo "‚ùå supabase/config.toml not found"
            exit 1
          fi
          echo "‚úÖ Supabase config found"

      - name: Load environment variables
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "‚úÖ Environment variables loaded from GitHub Secrets"

      # Option A: Link project (recommended for teams)
      - name: Link Supabase project
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "‚ö†Ô∏è  SUPABASE_ACCESS_TOKEN or SUPABASE_PROJECT_REF not set"
            echo "Skipping link step. Using direct DB URL instead."
          else
            supabase link --project-ref $SUPABASE_PROJECT_REF
          fi

      # Option B: Use direct DB URL (simpler, but requires connection string)
      - name: Apply migrations (Direct DB URL)
        if: env.SUPABASE_DB_URL != ''
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "‚ö†Ô∏è  SUPABASE_DB_URL not set. Skipping migrations."
            exit 0
          fi
          
          echo "üì¶ Applying migrations..."
          
          # Apply migrations in order
          for migration in supabase/migrations/*.sql; do
            if [ -f "$migration" ]; then
              echo "Applying: $migration"
              psql "$SUPABASE_DB_URL" -f "$migration" || {
                echo "‚ùå Migration failed: $migration"
                exit 1
              }
            fi
          done
          
          echo "‚úÖ All migrations applied"

      # Option C: Use supabase db push (if linked)
      - name: Apply migrations (via link)
        if: env.SUPABASE_ACCESS_TOKEN != '' && env.SUPABASE_PROJECT_REF != ''
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "üì¶ Pushing migrations to Supabase..."
          supabase db push --db-url "$SUPABASE_DB_URL" || {
            echo "‚ö†Ô∏è  db push failed, trying direct migration files..."
            for migration in supabase/migrations/*.sql; do
              if [ -f "$migration" ]; then
                echo "Applying: $migration"
                psql "$SUPABASE_DB_URL" -f "$migration" || exit 1
              fi
            done
          }
          echo "‚úÖ Migrations applied"

      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "‚ö†Ô∏è  SUPABASE_ACCESS_TOKEN or SUPABASE_PROJECT_REF not set"
            echo "Skipping function deployment."
            exit 0
          fi
          
          echo "üöÄ Deploying Edge Functions..."
          
          # Deploy all functions found in supabase/functions/
          if [ -d "supabase/functions" ]; then
            for func_dir in supabase/functions/*/; do
              if [ -d "$func_dir" ] && [ -f "$func_dir/index.ts" ]; then
                func_name=$(basename "$func_dir")
                echo "Deploying function: $func_name"
                supabase functions deploy "$func_name" --project-ref "$SUPABASE_PROJECT_REF" || {
                  echo "‚ùå Failed to deploy: $func_name"
                  exit 1
                }
              fi
            done
          else
            echo "‚ÑπÔ∏è  No functions directory found"
          fi
          
          echo "‚úÖ All functions deployed"

      - name: Set Function Secrets (optional)
        if: env.SUPABASE_ACCESS_TOKEN != '' && env.SUPABASE_PROJECT_REF != ''
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          if [ -f "supabase/.env.prod" ]; then
            echo "üîê Setting function secrets..."
            supabase secrets set --env-file supabase/.env.prod --project-ref "$SUPABASE_PROJECT_REF" || {
              echo "‚ö†Ô∏è  Failed to set secrets (may not be needed)"
            }
          else
            echo "‚ÑπÔ∏è  No .env.prod file found, skipping secrets"
          fi

      - name: Verify deployment
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          echo "‚úÖ Deployment complete!"
          echo ""
          echo "üìä Summary:"
          echo "  - Migrations: Applied"
          echo "  - Functions: Deployed"
          echo "  - Project: $SUPABASE_PROJECT_REF"
          echo ""
          echo "üîó View in Supabase Dashboard:"
          echo "  https://supabase.com/dashboard/project/$SUPABASE_PROJECT_REF"

