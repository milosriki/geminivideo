name: Deploy to Cloud Run

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ptd-fitness-demo
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY_REPO: geminivideo-repo
  GCS_BUCKET: ptd-fitness-demo_cloudbuild
  DOCKER_BUILDKIT: 1

jobs:
  # 1. Build Gateway API
  build-gateway:
    name: Build Gateway API
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/gateway-api:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/gateway-api:latest \
            ./services/gateway-api
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/gateway-api:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/gateway-api:latest

  # 2. Build Drive Intel (Heavy)
  build-drive-intel:
    name: Build Drive Intel
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/drive-intel:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/drive-intel:latest \
            ./services/drive-intel
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/drive-intel:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/drive-intel:latest

  # 3. Build Video Agent (Heavy)
  build-video-agent:
    name: Build Video Agent
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/video-agent:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/video-agent:latest \
            ./services/video-agent
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/video-agent:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/video-agent:latest

  # 4. Build Meta Publisher
  build-meta-publisher:
    name: Build Meta Publisher
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/meta-publisher:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/meta-publisher:latest \
            ./services/meta-publisher
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/meta-publisher:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/meta-publisher:latest

  # 5. Build ML Service
  build-ml-service:
    name: Build ML Service
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/ml-service:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/ml-service:latest \
            ./services/ml-service
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/ml-service:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/ml-service:latest

  # 6. Build Titan Core
  build-titan-core:
    name: Build Titan Core
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/titan-core:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/titan-core:latest \
            ./services/titan-core
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/titan-core:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/titan-core:latest

  # 7. Build Frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push
        run: |
          docker build -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/frontend:${{ github.sha }} \
            -t ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/frontend:latest \
            ./frontend
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/frontend:${{ github.sha }}
          docker push ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/frontend:latest

  # 8. Deploy All Services
  deploy:
    name: Deploy Services
    needs:
      [
        build-gateway,
        build-drive-intel,
        build-video-agent,
        build-meta-publisher,
        build-ml-service,
        build-titan-core,
        build-frontend,
      ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # Setup Secrets in Secret Manager (create if not exist, update if exist)
      - name: Setup Secret Manager Secrets
        run: |
          echo "Setting up secrets in Secret Manager..."

          # Function to create or update secret
          setup_secret() {
            local name=$1
            local value=$2

            if [ -z "$value" ] || [ "$value" == "" ]; then
              echo "Skipping $name (not set)"
              return
            fi

            # Check if secret exists
            if gcloud secrets describe "$name" --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
              echo "Updating secret: $name"
              echo -n "$value" | gcloud secrets versions add "$name" --data-file=- --project=${{ env.PROJECT_ID }}
            else
              echo "Creating secret: $name"
              echo -n "$value" | gcloud secrets create "$name" --data-file=- --replication-policy=automatic --project=${{ env.PROJECT_ID }}
            fi
          }

          # Setup all required secrets
          setup_secret "gemini-api-key" "${{ secrets.GEMINI_API_KEY }}"
          setup_secret "openai-api-key" "${{ secrets.OPENAI_API_KEY }}"
          setup_secret "anthropic-api-key" "${{ secrets.ANTHROPIC_API_KEY }}"
          setup_secret "database-url" "${{ secrets.DATABASE_URL }}"
          setup_secret "redis-url" "${{ secrets.REDIS_URL }}"
          setup_secret "supabase-url" "${{ secrets.SUPABASE_URL }}"
          setup_secret "supabase-key" "${{ secrets.SUPABASE_KEY }}"
          setup_secret "meta-access-token" "${{ secrets.META_ACCESS_TOKEN }}"

          echo "Secrets setup complete!"

      # Grant Cloud Run service account access to secrets
      - name: Grant Secret Access
        run: |
          SA="${{ env.PROJECT_ID }}@appspot.gserviceaccount.com"
          SECRETS=(gemini-api-key openai-api-key anthropic-api-key database-url redis-url supabase-url supabase-key meta-access-token)

          for secret in "${SECRETS[@]}"; do
            if gcloud secrets describe "$secret" --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
              echo "Granting access to $secret..."
              gcloud secrets add-iam-policy-binding "$secret" \
                --member="serviceAccount:$SA" \
                --role="roles/secretmanager.secretAccessor" \
                --project=${{ env.PROJECT_ID }} --quiet 2>/dev/null || true
            fi
          done

      # Deploy all backend services (can run in parallel as they don't depend on each other)
      - name: Deploy Drive Intel
        run: |
          SECRETS=""
          for s in "GEMINI_API_KEY=gemini-api-key" "OPENAI_API_KEY=openai-api-key" "SUPABASE_URL=supabase-url" "SUPABASE_KEY=supabase-key"; do
            secret_name="${s#*=}"
            if gcloud secrets describe "$secret_name" --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
              SECRETS="${SECRETS:+$SECRETS,}${s}:latest"
            fi
          done

          gcloud run deploy drive-intel \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/drive-intel:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=2Gi \
            --cpu=2 \
            --timeout=300 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }},GCP_REGION=${{ env.GCP_REGION }}" \
            ${SECRETS:+--set-secrets="$SECRETS"}

      - name: Deploy Video Agent
        run: |
          SECRETS=""
          for s in "GEMINI_API_KEY=gemini-api-key" "OPENAI_API_KEY=openai-api-key"; do
            secret_name="${s#*=}"
            if gcloud secrets describe "$secret_name" --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
              SECRETS="${SECRETS:+$SECRETS,}${s}:latest"
            fi
          done

          gcloud run deploy video-agent \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/video-agent:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=4Gi \
            --cpu=2 \
            --timeout=600 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }},GCP_REGION=${{ env.GCP_REGION }}" \
            ${SECRETS:+--set-secrets="$SECRETS"}

      - name: Deploy ML Service
        run: |
          SECRETS=""
          for s in "DATABASE_URL=database-url" "REDIS_URL=redis-url"; do
            secret_name="${s#*=}"
            if gcloud secrets describe "$secret_name" --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
              SECRETS="${SECRETS:+$SECRETS,}${s}:latest"
            fi
          done

          gcloud run deploy ml-service \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/ml-service:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=4Gi \
            --cpu=2 \
            --timeout=300 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }},GCP_REGION=${{ env.GCP_REGION }}" \
            ${SECRETS:+--set-secrets="$SECRETS"}

      - name: Deploy Meta Publisher
        run: |
          SECRETS=""
          for s in "META_ACCESS_TOKEN=meta-access-token" "SUPABASE_URL=supabase-url" "SUPABASE_KEY=supabase-key"; do
            secret_name="${s#*=}"
            if gcloud secrets describe "$secret_name" --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
              SECRETS="${SECRETS:+$SECRETS,}${s}:latest"
            fi
          done

          gcloud run deploy meta-publisher \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/meta-publisher:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=1Gi \
            --cpu=1 \
            --timeout=300 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }},GCP_REGION=${{ env.GCP_REGION }}" \
            ${SECRETS:+--set-secrets="$SECRETS"}

      - name: Deploy Titan Core
        run: |
          SECRETS=""
          for s in "GEMINI_API_KEY=gemini-api-key" "ANTHROPIC_API_KEY=anthropic-api-key" "OPENAI_API_KEY=openai-api-key"; do
            secret_name="${s#*=}"
            if gcloud secrets describe "$secret_name" --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
              SECRETS="${SECRETS:+$SECRETS,}${s}:latest"
            fi
          done

          gcloud run deploy titan-core \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/titan-core:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --memory=4Gi \
            --cpu=2 \
            --timeout=900 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }},GCP_REGION=${{ env.GCP_REGION }}" \
            ${SECRETS:+--set-secrets="$SECRETS"}

      - name: Deploy Gateway API
        run: |
          SECRETS=""
          for s in "GEMINI_API_KEY=gemini-api-key" "OPENAI_API_KEY=openai-api-key" "ANTHROPIC_API_KEY=anthropic-api-key" "DATABASE_URL=database-url" "REDIS_URL=redis-url" "SUPABASE_URL=supabase-url" "SUPABASE_KEY=supabase-key"; do
            secret_name="${s#*=}"
            if gcloud secrets describe "$secret_name" --project=${{ env.PROJECT_ID }} >/dev/null 2>&1; then
              SECRETS="${SECRETS:+$SECRETS,}${s}:latest"
            fi
          done

          gcloud run deploy gateway-api \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/gateway-api:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --ingress=all \
            --allow-unauthenticated \
            --memory=2Gi \
            --cpu=2 \
            --set-env-vars="PROJECT_ID=${{ env.PROJECT_ID }},GCS_BUCKET=${{ env.GCS_BUCKET }},GCP_REGION=${{ env.GCP_REGION }}" \
            ${SECRETS:+--set-secrets="$SECRETS"}

      - name: Deploy Frontend
        run: |
          gcloud run deploy frontend \
            --image=${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REGISTRY_REPO }}/frontend:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --platform=managed \
            --ingress=all \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1

      # Sync Config
      - run: |
          gsutil -m rsync -r -d ./shared/config gs://${{ env.GCS_BUCKET }}/config/
          gsutil -m rsync -r -d ./knowledge gs://${{ env.GCS_BUCKET }}/knowledge/

      # Output URLs
      - run: |
          echo "Deployment complete!"
          echo "Gateway API: $(gcloud run services describe gateway-api --region=${{ env.GCP_REGION }} --format='value(status.url)')"
          echo "Frontend: $(gcloud run services describe frontend --region=${{ env.GCP_REGION }} --format='value(status.url)')"
