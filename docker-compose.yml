version: '3.8'

services:
  # ========================================================================
  # INFRASTRUCTURE SERVICES
  # ========================================================================

  postgres:
    image: postgres:15-alpine
    container_name: geminivideo-postgres
    environment:
      POSTGRES_USER: geminivideo
      POSTGRES_PASSWORD: geminivideo
      POSTGRES_DB: geminivideo
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U geminivideo" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - geminivideo-network

  redis:
    image: redis:7-alpine
    container_name: geminivideo-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - geminivideo-network

  # ========================================================================
  # CORE BACKEND SERVICES
  # ========================================================================

  ml-service:
    build:
      context: ./services/ml-service
      dockerfile: Dockerfile
    container_name: geminivideo-ml-service
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8004
      - DATABASE_URL=postgres://user:pass@postgres:5432/geminivideo
      - REDIS_URL=redis://redis:6379
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GCS_BUCKET=${GCS_BUCKET}
    ports:
      - "8004:8004"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8004/health" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    volumes:
      - ./shared:/app/shared
      - ./services/ml-service/models:/app/models
    networks:
      - geminivideo-network

  titan-core:
    build:
      context: ./services/titan-core
      dockerfile: Dockerfile
    container_name: geminivideo-titan-core
    environment:
      PORT: 8084
      REDIS_URL: redis://redis:6379
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      META_APP_ID: ${META_APP_ID}
      META_ACCESS_TOKEN: ${META_ACCESS_TOKEN}
      META_AD_ACCOUNT_ID: ${META_AD_ACCOUNT_ID}
      META_CLIENT_TOKEN: ${META_CLIENT_TOKEN}
      META_APP_SECRET: ${META_APP_SECRET}
      ML_SERVICE_URL: http://ml-service:8004
    ports:
      - "8084:8084"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8084/health" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    volumes:
      - ./services/titan-core:/app
    networks:
      - geminivideo-network

  video-agent:
    build:
      context: ./services/video-agent
      dockerfile: Dockerfile
    container_name: geminivideo-video-agent
    environment:
      PORT: 8001
      DATABASE_URL: postgresql://geminivideo:geminivideo@postgres:5432/geminivideo
      REDIS_URL: redis://redis:6379
      ASSET_DIR: /tmp/assets
      VOICEOVER_DIR: /tmp/voiceovers
      OUTPUT_DIR: /tmp/outputs
    ports:
      - "8001:8001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8001/health" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    volumes:
      - ./shared:/app/shared
      - ./services/video-agent/src:/app/src
    networks:
      - geminivideo-network

  drive-intel:
    build:
      context: ./services/drive-intel
      dockerfile: Dockerfile
    container_name: geminivideo-drive-intel
    environment:
      DATABASE_URL: postgresql://geminivideo:geminivideo@postgres:5432/geminivideo
      REDIS_URL: redis://redis:6379
      PORT: 8002
    ports:
      - "8002:8002"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8002/health" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    volumes:
      - ./shared:/app/shared
      - ./services/drive-intel/src:/app/src
    networks:
      - geminivideo-network

  # ========================================================================
  # PUBLISHING SERVICES
  # ========================================================================

  meta-publisher:
    build:
      context: ./services/meta-publisher
      dockerfile: Dockerfile
    container_name: geminivideo-meta-publisher
    environment:
      PORT: 8083
      GATEWAY_URL: http://gateway-api:8000
      META_ACCESS_TOKEN: ${META_ACCESS_TOKEN}
      META_AD_ACCOUNT_ID: ${META_AD_ACCOUNT_ID}
      META_PAGE_ID: ${META_PAGE_ID}
      META_APP_ID: ${META_APP_ID}
      META_CLIENT_TOKEN: ${META_CLIENT_TOKEN}
      META_APP_SECRET: ${META_APP_SECRET}
      DATABASE_URL: postgresql://geminivideo:geminivideo@postgres:5432/geminivideo
    ports:
      - "8083:8083"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8083/health" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    volumes:
      - ./shared:/app/shared
    networks:
      - geminivideo-network

  tiktok-ads:
    build:
      context: ./services/tiktok-ads
      dockerfile: Dockerfile
    container_name: geminivideo-tiktok-ads
    environment:
      PORT: 8085
      TIKTOK_ACCESS_TOKEN: ${TIKTOK_ACCESS_TOKEN:-}
      TIKTOK_ADVERTISER_ID: ${TIKTOK_ADVERTISER_ID:-}
      DATABASE_URL: postgresql://geminivideo:geminivideo@postgres:5432/geminivideo
    ports:
      - "8085:8085"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/health" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    volumes:
      - ./services/tiktok-ads/src:/app/src
    networks:
      - geminivideo-network

  google-ads:
    build:
      context: ./services/google-ads
      dockerfile: Dockerfile
    container_name: geminivideo-google-ads
    environment:
      PORT: 8086
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_DEVELOPER_TOKEN: ${GOOGLE_DEVELOPER_TOKEN:-}
      GOOGLE_REFRESH_TOKEN: ${GOOGLE_REFRESH_TOKEN:-}
      GOOGLE_ADS_CUSTOMER_ID: ${GOOGLE_ADS_CUSTOMER_ID:-}
      DATABASE_URL: postgresql://geminivideo:geminivideo@postgres:5432/geminivideo
    ports:
      - "8086:8086"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8086/health" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - geminivideo-network

  # ========================================================================
  # GATEWAY & FRONTEND
  # ========================================================================

  gateway-api:
    build:
      context: ./services/gateway-api
      dockerfile: Dockerfile
    container_name: geminivideo-gateway-api
    environment:
      - NODE_ENV=production
      - PORT=8000
      - DATABASE_URL=postgres://user:pass@postgres:5432/geminivideo
      - REDIS_URL=redis://redis:6379
      - ML_SERVICE_URL=http://ml-service:8004
      - VIDEO_AGENT_URL=http://video-agent:8001
      - DRIVE_INTEL_URL=http://drive-intel:8002
      - RAG_SERVICE_URL=http://rag-service:8003
      - TITAN_CORE_URL=http://titan-core:8084
      - META_PUBLISHER_URL=http://meta-publisher:8083
      - TIKTOK_ADS_URL=http://tiktok-ads:8085
      - GOOGLE_ADS_URL=http://google-ads:8086
      - JWT_SECRET=${JWT_SECRET}
      - META_ACCESS_TOKEN=${META_ACCESS_TOKEN}
      - GOOGLE_ADS_CLIENT_ID=${GOOGLE_ADS_CLIENT_ID}
      - TIKTOK_ACCESS_TOKEN=${TIKTOK_ACCESS_TOKEN}
    ports:
      - "8000:8000"
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
      ml-service:
        condition: service_healthy
      titan-core:
        condition: service_healthy
      video-agent:
        condition: service_healthy
      drive-intel:
        condition: service_healthy
      meta-publisher:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/health" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    volumes:
      - ./shared:/app/shared
    networks:
      - geminivideo-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: http://localhost:8000
    container_name: geminivideo-frontend
    environment:
      VITE_API_BASE_URL: http://localhost:8000
    ports:
      - "3000:80"
    depends_on:
      gateway-api:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/" ]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    networks:
      - geminivideo-network

  # ========================================================================
  # BACKGROUND WORKERS
  # ========================================================================

  drive-worker:
    build:
      context: ./services/drive-intel
      dockerfile: Dockerfile
    container_name: geminivideo-drive-worker
    command: python worker.py
    environment:
      DATABASE_URL: postgresql://geminivideo:geminivideo@postgres:5432/geminivideo
      REDIS_URL: redis://redis:6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./shared:/app/shared
      - ./services/drive-intel/src:/app/src
    networks:
      - geminivideo-network

  video-worker:
    build:
      context: ./services/video-agent
      dockerfile: Dockerfile
    container_name: geminivideo-video-worker
    command: python worker.py
    environment:
      DATABASE_URL: postgresql://geminivideo:geminivideo@postgres:5432/geminivideo
      REDIS_URL: redis://redis:6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./shared:/app/shared
      - ./services/video-agent/src:/app/src
    networks:
      - geminivideo-network

  safe-executor-worker:
    build:
      context: ./services/gateway-api
      dockerfile: Dockerfile
    container_name: geminivideo-safe-executor-worker
    command: npm run worker:safe-executor:prod
    environment:
      DATABASE_URL: postgresql://geminivideo:geminivideo@postgres:5432/geminivideo
      REDIS_URL: redis://redis:6379
      META_ACCESS_TOKEN: ${META_ACCESS_TOKEN}
      META_API_VERSION: ${META_API_VERSION:-v18.0}
      WORKER_ID: ${SAFE_EXECUTOR_WORKER_ID:-safe-executor-1}
      POLL_INTERVAL_MS: ${SAFE_EXECUTOR_POLL_INTERVAL_MS:-5000}
      BATCH_MODE_ENABLED: ${BATCH_MODE_ENABLED:-true}
      BATCH_SIZE: ${BATCH_SIZE:-10}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    volumes:
      - ./shared:/app/shared
    networks:
      - geminivideo-network

networks:
  geminivideo-network:
    driver: bridge

volumes:
  postgres_data:
